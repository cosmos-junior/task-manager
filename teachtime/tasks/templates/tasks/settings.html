<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Settings - Time Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .settings-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .back-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Notification Settings</h1>
            <p>Configure how and when you want to receive task reminders</p>
            <a href="{% url 'tasks:dashboard' %}" class="back-link">‚Üê Back to Dashboard</a>
        </div>

        <div class="success-message" id="success-message">
            Settings saved successfully!
        </div>

        <div class="settings-card">
            <h2>üìß Email Notifications</h2>
            <form id="settings-form">
                {% csrf_token %}
                
                <div class="checkbox-group">
                    <input type="checkbox" id="email_reminders" name="email_reminders">
                    <label for="email_reminders">Send daily email reminders</label>
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" value="{{ user.email }}" required>
                    <small>Your email from account registration: {{ user.email }}</small>
                </div>

                <h2>üì± SMS Notifications</h2>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="sms_reminders" name="sms_reminders">
                    <label for="sms_reminders">Send SMS reminders</label>
                </div>

                <div class="form-group">
                    <label for="phone_number">Phone Number</label>
                    <input type="tel" id="phone_number" name="phone_number" placeholder="+1234567890">
                    <small>Include country code (e.g., +1 for US)</small>
                </div>

                <h2>üîî Push Notifications</h2>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="push_reminders" name="push_reminders">
                    <label for="push_reminders">Send browser push notifications</label>
                </div>

                <h2>‚è∞ Reminder Time</h2>
                
                <div class="form-group">
                    <label for="reminder_time">Daily reminder time</label>
                    <input type="time" id="reminder_time" name="reminder_time" value="08:00">
                </div>

                <button type="submit" class="btn-primary">Save Settings</button>
                <button type="button" class="btn-secondary" onclick="testReminder()">Test Email Now</button>
            </form>
        </div>
    </div>

    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Load current settings
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });

        async function loadSettings() {
            try {
                const response = await fetch('/api/notification-settings/');
                if (response.ok) {
                    const settings = await response.json();
                    
                    document.getElementById('email_reminders').checked = settings.email_reminders;
                    document.getElementById('sms_reminders').checked = settings.sms_reminders;
                    document.getElementById('push_reminders').checked = settings.push_reminders;
                    document.getElementById('reminder_time').value = settings.reminder_time;
                    document.getElementById('phone_number').value = settings.phone_number;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save settings
        document.getElementById('settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                email_reminders: document.getElementById('email_reminders').checked,
                sms_reminders: document.getElementById('sms_reminders').checked,
                push_reminders: document.getElementById('push_reminders').checked,
                reminder_time: document.getElementById('reminder_time').value,
                phone_number: document.getElementById('phone_number').value
            };

            try {
                const response = await fetch('/api/notification-settings/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    document.getElementById('success-message').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('success-message').style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        });

        // Test email reminder
        async function testReminder() {
            try {
                const response = await fetch('/api/send-reminder/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ type: 'email' })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Test email sent! Check your inbox.');
                } else {
                    alert('Failed to send test email: ' + result.message);
                }
            } catch (error) {
                console.error('Error sending test email:', error);
                alert('Error sending test email');
            }
        }
    </script>
</body>
</html>